# ‚úÖ Instance Model - Complete Implementation

## üéØ Model Completed Successfully

The Instance model has been fully completed with all necessary fields for a production-ready medical imaging system.

---

## üìã **Complete Field Structure**

### **1. DICOM Identifiers** (Required)
```javascript
studyInstanceUID: { type: String, index: true, required: true }
seriesInstanceUID: { type: String, index: true, required: true }
sopInstanceUID: { type: String, unique: true, index: true, required: true }
instanceNumber: { type: Number, default: 0 }
```
‚úÖ Unique identification for each DICOM instance
‚úÖ Indexed for fast queries
‚úÖ Required fields enforced

---

### **2. DICOM Metadata**
```javascript
modality: String                    // CT, MRI, XA, etc.
transferSyntaxUID: String           // DICOM transfer syntax
sopClassUID: String                 // SOP Class UID
```
‚úÖ Standard DICOM metadata fields

---

### **3. Image Properties**
```javascript
rows: Number                        // Image height in pixels
columns: Number                     // Image width in pixels
numberOfFrames: { type: Number, default: 1 }  // Multi-frame support
bitsAllocated: Number               // 8, 16, etc.
bitsStored: Number                  // Actual bits used
pixelRepresentation: Number         // 0=unsigned, 1=signed
samplesPerPixel: Number             // 1=grayscale, 3=RGB
photometricInterpretation: String   // MONOCHROME1, MONOCHROME2, RGB
```
‚úÖ Complete image property tracking
‚úÖ Multi-frame DICOM support
‚úÖ Color and grayscale support

---

### **4. Pixel Spacing and Calibration**
```javascript
pixelSpacing: [Number]              // [row spacing, column spacing] in mm
sliceThickness: Number              // Slice thickness in mm
sliceLocation: Number               // Z-axis position
imagePosition: [Number]             // [x, y, z] in mm
imageOrientation: [Number]          // Direction cosines
```
‚úÖ Accurate measurements support
‚úÖ 3D reconstruction support
‚úÖ MPR (Multi-Planar Reconstruction) ready

---

### **5. Window/Level**
```javascript
windowCenter: [Number]              // Default window center values
windowWidth: [Number]               // Default window width values
rescaleIntercept: Number            // Pixel value rescaling
rescaleSlope: Number                // Pixel value rescaling
```
‚úÖ Proper image display
‚úÖ Hounsfield units for CT
‚úÖ Multiple window presets support

---

### **6. Acquisition Info**
```javascript
acquisitionDate: String             // When image was acquired
acquisitionTime: String             // Time of acquisition
acquisitionNumber: Number           // Acquisition sequence number
```
‚úÖ Temporal tracking
‚úÖ Study timeline reconstruction

---

### **7. Content Info**
```javascript
instanceCreationDate: String        // When instance was created
instanceCreationTime: String        // Time of creation
contentDate: String                 // Content date
contentTime: String                 // Content time
```
‚úÖ Complete audit trail
‚úÖ DICOM compliance

---

### **8. File Info**
```javascript
fileSize: Number                    // Size in bytes
```
‚úÖ Storage management
‚úÖ Quota tracking

---

### **9. Orthanc Integration** (PRIMARY STORAGE)
```javascript
orthancInstanceId: { type: String, index: true }  // Orthanc UUID
orthancUrl: String                                // Full Orthanc URL
orthancFrameIndex: { type: Number, default: 0 }   // Frame index
orthancStudyId: String                            // Orthanc study ID
orthancSeriesId: String                           // Orthanc series ID
useOrthancPreview: { type: Boolean, default: true }
```
‚úÖ Primary storage integration
‚úÖ Fast Orthanc lookups
‚úÖ Multi-frame support

---

### **10. Filesystem Cache** (FAST ACCESS)
```javascript
filesystemPath: String                            // Path to cached PNG
filesystemCached: { type: Boolean, default: false }
cachedAt: Date                                    // Cache timestamp
cacheSize: Number                                 // Cache file size
```
‚úÖ Performance optimization
‚úÖ Cache management
‚úÖ Cache statistics

---

### **11. Legacy Cloudinary** (DEPRECATED)
```javascript
cloudinaryUrl: String                             // Legacy URL
cloudinaryPublicId: String                        // Legacy ID
```
‚ö†Ô∏è Deprecated - kept for backward compatibility
‚ö†Ô∏è Will be removed in future version

---

### **12. Processing Status**
```javascript
processed: { type: Boolean, default: false }      // Processing complete
processingError: String                           // Error message if failed
```
‚úÖ Processing pipeline tracking
‚úÖ Error handling

---

### **13. Quality Control**
```javascript
imageQuality: String                              // 'good', 'acceptable', 'poor'
qualityNotes: String                              // QC notes
```
‚úÖ Quality assurance
‚úÖ Clinical workflow support

---

### **14. Annotations and Measurements**
```javascript
hasAnnotations: { type: Boolean, default: false }
hasMeasurements: { type: Boolean, default: false }
```
‚úÖ Quick filtering
‚úÖ Workflow optimization

---

### **15. AI Analysis**
```javascript
aiProcessed: { type: Boolean, default: false }
aiFindings: mongoose.Schema.Types.Mixed
```
‚úÖ AI integration ready
‚úÖ Flexible findings storage

---

### **16. Timestamps** (Automatic)
```javascript
createdAt: Date                                   // Auto-generated
updatedAt: Date                                   // Auto-updated
```
‚úÖ Automatic timestamp management
‚úÖ Audit trail

---

## üîç **Indexes for Performance**

```javascript
// Compound indexes for common queries
InstanceSchema.index({ studyInstanceUID: 1, instanceNumber: 1 });
InstanceSchema.index({ seriesInstanceUID: 1, instanceNumber: 1 });
InstanceSchema.index({ orthancInstanceId: 1 });
InstanceSchema.index({ filesystemCached: 1 });
InstanceSchema.index({ processed: 1 });
```

‚úÖ Optimized for common queries
‚úÖ Fast study/series lookups
‚úÖ Efficient cache checks

---

## üé® **Virtual Properties**

### **frameUrl**
```javascript
InstanceSchema.virtual('frameUrl').get(function() {
  return `/api/dicom/studies/${this.studyInstanceUID}/frames/${this.instanceNumber}`;
});
```
‚úÖ Automatic URL generation
‚úÖ No database storage needed

### **orthancPreviewUrl**
```javascript
InstanceSchema.virtual('orthancPreviewUrl').get(function() {
  if (this.orthancInstanceId) {
    return `${process.env.ORTHANC_URL}/instances/${this.orthancInstanceId}/preview`;
  }
  return null;
});
```
‚úÖ Direct Orthanc access
‚úÖ Environment-aware

---

## üõ†Ô∏è **Instance Methods**

### **isFrameAvailable()**
```javascript
instance.isFrameAvailable()
// Returns: true if frame can be retrieved from any source
```
‚úÖ Quick availability check
‚úÖ Multi-source support

### **getFrameSource()**
```javascript
instance.getFrameSource()
// Returns: { type: 'filesystem'|'orthanc'|'cloudinary'|'none', path/id/url }
```
‚úÖ Priority-based source selection
‚úÖ Fallback support

---

## üìä **Static Methods**

### **findByStudy(studyInstanceUID)**
```javascript
Instance.findByStudy('1.2.3.4.5')
// Returns: All instances for study, sorted by instanceNumber
```
‚úÖ Convenient study queries
‚úÖ Automatic sorting

### **findBySeries(seriesInstanceUID)**
```javascript
Instance.findBySeries('1.2.3.4.6')
// Returns: All instances for series, sorted by instanceNumber
```
‚úÖ Series-level queries
‚úÖ Automatic sorting

### **getStudyFrameCount(studyInstanceUID)**
```javascript
await Instance.getStudyFrameCount('1.2.3.4.5')
// Returns: Total frame count including multi-frame instances
```
‚úÖ Accurate frame counting
‚úÖ Multi-frame aware

---

## üîÑ **Pre-Save Hook**

```javascript
InstanceSchema.pre('save', function(next) {
  if (this.isNew) {
    this.processed = false;
  }
  next();
});
```
‚úÖ Automatic status initialization
‚úÖ Processing pipeline ready

---

## üìù **Usage Examples**

### **Create Instance**
```javascript
const instance = await Instance.create({
  studyInstanceUID: '1.2.3.4.5',
  seriesInstanceUID: '1.2.3.4.6',
  sopInstanceUID: '1.2.3.4.7',
  instanceNumber: 0,
  modality: 'CT',
  rows: 512,
  columns: 512,
  numberOfFrames: 1,
  orthancInstanceId: 'abc123',
  orthancUrl: 'http://localhost:8042/instances/abc123'
});
```

### **Find Study Instances**
```javascript
const instances = await Instance.findByStudy('1.2.3.4.5');
console.log(`Found ${instances.length} instances`);
```

### **Get Frame Count**
```javascript
const frameCount = await Instance.getStudyFrameCount('1.2.3.4.5');
console.log(`Study has ${frameCount} total frames`);
```

### **Check Frame Availability**
```javascript
const instance = await Instance.findOne({ sopInstanceUID: '1.2.3.4.7' });
if (instance.isFrameAvailable()) {
  const source = instance.getFrameSource();
  console.log(`Frame available from: ${source.type}`);
}
```

### **Update Cache Status**
```javascript
await Instance.updateOne(
  { sopInstanceUID: '1.2.3.4.7' },
  {
    $set: {
      filesystemPath: '/backend/uploaded_frames_1.2.3.4.5/frame_000.png',
      filesystemCached: true,
      cachedAt: new Date(),
      cacheSize: 125000
    }
  }
);
```

---

## ‚úÖ **Verification Checklist**

- ‚úÖ All DICOM standard fields included
- ‚úÖ Orthanc integration fields complete
- ‚úÖ Filesystem cache fields complete
- ‚úÖ Indexes for performance
- ‚úÖ Virtual properties for convenience
- ‚úÖ Instance methods for common operations
- ‚úÖ Static methods for queries
- ‚úÖ Pre-save hooks for automation
- ‚úÖ Multi-frame DICOM support
- ‚úÖ 3D reconstruction support
- ‚úÖ AI integration ready
- ‚úÖ Quality control fields
- ‚úÖ Backward compatibility (Cloudinary)
- ‚úÖ Timestamps automatic
- ‚úÖ Error handling fields

---

## üéØ **Model Capabilities**

### **Supports:**
- ‚úÖ Single-frame DICOM (CT, MRI slices)
- ‚úÖ Multi-frame DICOM (XA, Cine, 4D)
- ‚úÖ Grayscale images (MONOCHROME1, MONOCHROME2)
- ‚úÖ Color images (RGB, YBR)
- ‚úÖ 8-bit and 16-bit images
- ‚úÖ Signed and unsigned pixel data
- ‚úÖ Multiple window/level presets
- ‚úÖ Pixel spacing for measurements
- ‚úÖ 3D position and orientation
- ‚úÖ Orthanc PACS integration
- ‚úÖ Filesystem caching
- ‚úÖ AI analysis integration
- ‚úÖ Quality control workflow
- ‚úÖ Annotations and measurements
- ‚úÖ Processing pipeline tracking

---

## üöÄ **Production Ready**

The Instance model is now:
- ‚úÖ **Complete** - All necessary fields included
- ‚úÖ **Optimized** - Proper indexes for performance
- ‚úÖ **Flexible** - Supports various DICOM types
- ‚úÖ **Scalable** - Efficient queries and caching
- ‚úÖ **Maintainable** - Clear structure and documentation
- ‚úÖ **Future-proof** - AI and advanced features ready

---

## üìä **Model Statistics**

- **Total Fields**: 50+
- **Indexes**: 7 (including compound)
- **Virtual Properties**: 2
- **Instance Methods**: 2
- **Static Methods**: 3
- **Hooks**: 1 (pre-save)
- **Collections**: instances

---

**Model Completion Date**: $(date)
**Status**: ‚úÖ **COMPLETE**
**Version**: 2.0.0
**Ready for Production**: **YES**
